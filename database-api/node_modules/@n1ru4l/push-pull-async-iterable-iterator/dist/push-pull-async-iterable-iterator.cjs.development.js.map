{"version":3,"file":"push-pull-async-iterable-iterator.cjs.development.js","sources":["../src/makePushPullAsyncIterableIterator.ts","../src/makeAsyncIterableIteratorFromSink.ts","../src/applyAsyncIterableIteratorToSink.ts","../src/isAsyncIterable.ts"],"sourcesContent":["type Deferred<T> = {\r\n  resolve: (value: T) => void;\r\n  reject: (value: unknown) => void;\r\n  promise: Promise<T>;\r\n};\r\n\r\nfunction createDeferred<T>(): Deferred<T> {\r\n  const d = {} as Deferred<T>;\r\n  d.promise = new Promise<T>((resolve, reject) => {\r\n    d.resolve = resolve;\r\n    d.reject = reject;\r\n  });\r\n  return d;\r\n}\r\n\r\nexport type PushPullAsyncIterableIterator<T> = {\r\n  /* Push a new value that will be published on the AsyncIterableIterator. */\r\n  pushValue: (value: T) => void;\r\n  /* AsyncIterableIterator that publishes the values pushed on the stack with pushValue. */\r\n  asyncIterableIterator: AsyncIterableIterator<T>;\r\n};\r\n\r\nconst SYMBOL_FINISHED = Symbol();\r\nconst SYMBOL_NEW_VALUE = Symbol();\r\n\r\n/**\r\n * makePushPullAsyncIterableIterator\r\n *\r\n * The iterable will publish values until return or throw is called.\r\n * Afterwards it is in the completed state and cannot be used for publishing any further values.\r\n * It will handle back-pressure and keep pushed values until they are consumed by a source.\r\n */\r\nexport function makePushPullAsyncIterableIterator<\r\n  T\r\n>(): PushPullAsyncIterableIterator<T> {\r\n  let isRunning = true;\r\n  const values: Array<T> = [];\r\n\r\n  let newValueD = createDeferred<typeof SYMBOL_NEW_VALUE>();\r\n  let finishedD = createDeferred<typeof SYMBOL_FINISHED | any>();\r\n\r\n  const asyncIterableIterator = (async function* PushPullAsyncIterableIterator(): AsyncIterableIterator<\r\n    T\r\n  > {\r\n    while (true) {\r\n      if (values.length > 0) {\r\n        yield values.shift()!;\r\n      } else {\r\n        const result = await Promise.race([\r\n          newValueD.promise,\r\n          finishedD.promise\r\n        ]);\r\n\r\n        if (result === SYMBOL_FINISHED) {\r\n          break;\r\n        }\r\n        if (result !== SYMBOL_NEW_VALUE) {\r\n          throw result;\r\n        }\r\n      }\r\n    }\r\n  })();\r\n\r\n  function pushValue(value: T) {\r\n    if (isRunning === false) {\r\n      // TODO: Should this throw?\r\n      return;\r\n    }\r\n\r\n    values.push(value);\r\n    newValueD.resolve(SYMBOL_NEW_VALUE);\r\n    newValueD = createDeferred();\r\n  }\r\n\r\n  // We monkey patch the original generator for clean-up\r\n  const originalReturn = asyncIterableIterator.return!.bind(\r\n    asyncIterableIterator\r\n  );\r\n\r\n  asyncIterableIterator.return = (\r\n    ...args\r\n  ): Promise<IteratorResult<T, void>> => {\r\n    isRunning = false;\r\n    finishedD.resolve(SYMBOL_FINISHED);\r\n    return originalReturn(...args);\r\n  };\r\n\r\n  const originalThrow = asyncIterableIterator.throw!.bind(\r\n    asyncIterableIterator\r\n  );\r\n  asyncIterableIterator.throw = (err): Promise<IteratorResult<T, void>> => {\r\n    isRunning = false;\r\n    finishedD.resolve(err);\r\n    return originalThrow(err);\r\n  };\r\n\r\n  return {\r\n    pushValue,\r\n    asyncIterableIterator\r\n  };\r\n}\r\n","import { makePushPullAsyncIterableIterator } from \"./makePushPullAsyncIterableIterator\";\r\nimport { Sink } from \"./Sink\";\r\n\r\nexport const makeAsyncIterableIteratorFromSink = <\r\n  TValue = unknown,\r\n  TError = unknown\r\n>(\r\n  make: (sink: Sink<TValue, TError>) => () => void\r\n): AsyncIterableIterator<TValue> => {\r\n  const {\r\n    pushValue,\r\n    asyncIterableIterator\r\n  } = makePushPullAsyncIterableIterator<TValue>();\r\n  const dispose = make({\r\n    next: (value: TValue) => {\r\n      pushValue(value);\r\n    },\r\n    complete: () => {\r\n      asyncIterableIterator.return!();\r\n    },\r\n    error: (err: TError) => {\r\n      asyncIterableIterator.throw!(err);\r\n    }\r\n  });\r\n  const originalReturn = asyncIterableIterator.return!;\r\n  let returnValue: ReturnType<typeof originalReturn> | undefined = undefined;\r\n  asyncIterableIterator.return = () => {\r\n    if (returnValue === undefined) {\r\n      dispose();\r\n      returnValue = originalReturn();\r\n    }\r\n    return returnValue;\r\n  };\r\n  return asyncIterableIterator;\r\n};\r\n","import { Sink } from \"./Sink\";\r\n\r\nexport function applyAsyncIterableIteratorToSink<\r\n  TValue = unknown,\r\n  TError = unknown\r\n>(\r\n  asyncIterableIterator: AsyncIterableIterator<TValue>,\r\n  sink: Sink<TValue, TError>\r\n): () => void {\r\n  const run = async () => {\r\n    try {\r\n      for await (const value of asyncIterableIterator) {\r\n        sink.next(value);\r\n      }\r\n      sink.complete();\r\n    } catch (err) {\r\n      sink.error(err);\r\n    }\r\n  };\r\n  run();\r\n\r\n  return () => {\r\n    asyncIterableIterator.return?.();\r\n  };\r\n}\r\n","export function isAsyncIterable(\r\n  input: unknown\r\n): input is AsyncIterator<unknown> | AsyncIterableIterator<unknown> {\r\n  return (\r\n    typeof input === \"object\" &&\r\n    input !== null &&\r\n    // The AsyncGenerator check is for Safari on iOS which currently does not have\r\n    // Symbol.asyncIterator implemented\r\n    // That means every custom AsyncIterable must be built using a AsyncGeneratorFunction (async function * () {})\r\n    ((input as any)[Symbol.toStringTag] === \"AsyncGenerator\" ||\r\n      (Symbol.asyncIterator && Symbol.asyncIterator in input))\r\n  );\r\n}\r\n"],"names":["createDeferred","d","promise","Promise","resolve","reject","SYMBOL_FINISHED","Symbol","SYMBOL_NEW_VALUE","makePushPullAsyncIterableIterator","isRunning","values","newValueD","finishedD","asyncIterableIterator","PushPullAsyncIterableIterator","length","shift","result","race","pushValue","value","push","originalReturn","return","bind","args","originalThrow","throw","err","makeAsyncIterableIteratorFromSink","make","dispose","next","complete","error","returnValue","undefined","applyAsyncIterableIteratorToSink","sink","run","isAsyncIterable","input","toStringTag","asyncIterator"],"mappings":"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"}